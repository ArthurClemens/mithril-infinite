!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("mithril"),require("verge"),require("j2c")):"function"==typeof define&&define.amd?define(["mithril","verge","j2c"],t):e["mithril-infinite"]=t(e.m,e.verge,e.j2c)}(this,function(e,t,n){"use strict";function r(e,t){return t={exports:{}},e(t,t.exports),t.exports}e="default"in e?e.default:e,t="default"in t?t.default:t,n="default"in n?n.default:n;var i,a={scrollView:"mithril-infinite__scroll-view",scrollViewX:"mithril-infinite__scroll-view--x",scrollViewY:"mithril-infinite__scroll-view--y",scrollContent:"mithril-infinite__scroll-content",content:"mithril-infinite__content",pages:"mithril-infinite__pages",page:"mithril-infinite__page",pageEven:"mithril-infinite__page--even",pageOdd:"mithril-infinite__page--odd",placeholder:"mithril-infinite__page--placeholder",before:"mithril-infinite__before",after:"mithril-infinite__after"},o=300,l=function(e,t){var n=window.getComputedStyle(e);if("x"===t){var r=parseFloat(n.marginLeft)+parseFloat(n.marginRight);return e.scrollWidth+r}var i=parseFloat(n.marginTop)+parseFloat(n.marginBottom);return e.scrollHeight+i},s=function(e){var n=e.el,r=e.axis,i=void 0===r?"y":r,a=e.leeway,l=void 0===a?o:a;return"y"===i?t.inY(n,l)||t.inY(n,-l):"x"===i?t.inX(n,l)||t.inX(n,-l):t.inViewport(n,l)||t.inViewport(n,-l)},c=function(e){return[a.page,e%2===0?a.pageEven:a.pageOdd].join(" ")},u=r(function(e){function t(){function e(){return arguments.length>0&&arguments[0]!==z&&r(e,arguments[0]),e._state.value}return n(e),arguments.length>0&&arguments[0]!==z&&r(e,arguments[0]),e}function n(e){e.constructor=t,e._state={id:w++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0},e.map=e["fantasy-land/map"]=d,e["fantasy-land/ap"]=f,e["fantasy-land/of"]=t,e.valueOf=p,e.toJSON=g,e.toString=p,Object.defineProperties(e,{end:{get:function(){if(!e._state.endStream){var n=t();n.map(function(t){return t===!0&&(u(e),u(n)),t}),e._state.endStream=n}return e._state.endStream}}})}function r(e,t){i(e,t);for(var n in e._state.deps)a(e._state.deps[n],!1);o(e)}function i(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function a(e,t){var n=e._state,r=n.parents;if(r.length>0&&r.every(v)&&(t||r.some(m))){var a=e._state.derive();if(a===z)return!1;i(e,a)}}function o(e){e._state.changed=!1;for(var t in e._state.deps)e._state.deps[t]._state.changed=!1}function l(e,n){if(!n.every(h))throw new Error("Ensure that each item passed to m.prop.combine/m.prop.merge is a stream");return s(t(),n,function(){return e.apply(this,n.concat([n.filter(m)]))})}function s(e,t,n){var r=e._state;return r.derive=n,r.parents=t.filter(S),c(e,r.parents),a(e,!0),e}function c(e,t){for(var n=0;n<t.length;n++)t[n]._state.deps[e._state.id]=e,c(e,t[n]._state.parents)}function u(e){for(var t=0;t<e._state.parents.length;t++){var n=e._state.parents[t];delete n._state.deps[e._state.id]}for(var r in e._state.deps){var i=e._state.deps[r],a=i._state.parents.indexOf(e);a>-1&&i._state.parents.splice(a,1)}e._state.state=2,e._state.deps={}}function d(e){return l(function(t){return e(t())},[this])}function f(e){return l(function(e,t){return e()(t())},[e,this])}function p(){return this._state.value}function g(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function h(e){return e._state}function v(e){return 1===e._state.state}function m(e){return e._state.changed}function S(e){return 2!==e._state.state}function _(e){return l(function(){return e.map(function(e){return e()})},e)}var w=0,z={};t["fantasy-land/of"]=t,t.merge=_,t.combine=l,t.HALT=z,e.exports=t}),d=u,f=function(t){return e.request({method:"GET",url:t})},p=function(e){var t=e.state,n=e.attrs,r=n.pageNum,i=d([]);if(n.pageData){var a=n.pageData(r);a.then?a.then(i):i=a}else if(n.pageUrl){var o=n.pageUrl(r);f(o).then(i)}var l=n.processPageData||function(e,t){return e&&e.length?e.map(function(e,r){return n.item(e,t,r)}):null};t.content=i,t.className=c(r),t.pageTag=n.pageTag||"div",t.processPageData=l},g=function(t){var n=t.state,r=t.attrs,i=r.pageId,a=r.pageSizes[i]||0,o=0;r.pageSize&&(o=r.pageSize(n.content()),r.updatePageSize(i,o));var s=o?o+"px":!r.autoSize||r.isScrolling&&a?a+"px":"auto",c=function(t){if(!o){var n=l(t,r.axis);n&&r.updatePageSize(i,n),a||setTimeout(e.redraw,0)}};return e(n.pageTag,{"data-page":i,class:n.className,style:a?"x"===r.axis?{width:s}:{height:s}:null,oncreate:function(e){var t=e.dom;return c(t)},onupdate:function(e){var t=e.dom;return c(t)}},n.processPageData(n.content(),{isScrolling:r.isScrolling,pageId:r.pageId,pageNum:r.pageNum}))},h={oninit:p,view:g},v=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},S={oninit:function(e){return e.state.className=c(e.attrs.pageNum)},view:function(t){var n=t.state,r=t.attrs,i=r.pageId,o=r.pageSizes[i]||0;return e("div",{"data-page":i,class:[a.placeholder,n.className].join(" "),style:m({},"x"===r.axis?{width:o+"px"}:{height:o+"px"})})}},_=new n,w=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];z(e);var i=document.createElement("style");e&&i.setAttribute("id",e),n.forEach(function(e){Object.keys(e).length&&e.forEach(function(e){var t={"@global":e},n=_.sheet(t);i.appendChild(document.createTextNode(n))})}),document.head.appendChild(i)},z=function(e){if(e){var t=document.getElementById(e);t&&t.parentNode.removeChild(t)}},x=[v({},"."+a.scrollView,(i={"-webkit-overflow-scrolling":"touch",height:"100%"},v(i,"&."+a.scrollViewY,v({overflowX:"hidden",overflowY:"auto",height:"100%"}," ."+a.scrollContent,{height:"100%"})),v(i,"&."+a.scrollViewX,v({overflowX:"auto",overflowY:"hidden",width:"100%"}," ."+a.scrollContent,{width:"100%"})),i))];w("mithril-infinite",x);var y=200,b="000000",V=function(e){return b.substring(0,b.length-(""+e).length)+e},P=function(e,t){var n=t.sortedKeys;if(0===n.length)return 1;for(var r=t.beforeSize||0,i=1,a=0;a<n.length;a+=1){var o=n[a];e>r&&(i=parseInt(o,10)),r+=t.pageSizes[o]}return i},N=function(e,t,n){var r=Math.max(0,e-1);if(t<r)return 0;var i=t,a=n.sortedKeys.slice(r,i),o=n.beforeSize||0;return o=a.reduce(function(e,t){return e+=n.pageSizes[t]||0},o),o+=n.afterSize||0},T=function(e,t,n,r){if(!r)return!1;var i=V(e),a=r.querySelector('[data-page="'+i+'"]');return s({el:a,axis:t})},I=function(e){return function(t,n){return e.pageSizes[t]=n,e.sortedKeys=Object.keys(e.pageSizes).sort()}},C=function(t,n,r){var i=function(){t.isScrolling=!0,clearTimeout(t.scrollWatchScrollingStateId),t.scrollWatchScrollingStateId=setTimeout(function(){t.isScrolling=!1,e.redraw()},t.scrollThrottle),t.scrollWatchUpdateStateId||(t.scrollWatchUpdateStateId=setTimeout(function(){e.redraw(),t.scrollWatchUpdateStateId=null},t.scrollThrottle))};"add"===r?n.addEventListener("scroll",i):n.removeEventListener("scroll",i)},E=function(e,t,n,r){var i=l(e,r);i&&(n[t]=i)},O=function(e,t,n,r,i,a){for(var o=t?parseInt(t,10):r?r:1,l=n?parseInt(n,10):r?r:a,s=[],c=[],u=-i;u<=i;u+=1){var d=e+u;d>=o&&d<=l&&s.push(d)}for(var f=1;f<s[0];f+=1)c.push(f);return{pages:s,prePages:c,maxPageNum:l}},j=function(e){var t=e.attrs,n=t.axis||"y",r="x"===n?"scrollLeft":"scrollTop",i=void 0===t.autoSize||t.autoSize!==!1,o=t.pageSize,l=void 0!==t.throttle?1e3*t.throttle:y,s=t.contentTag||"div",c=[a.scrollView,"x"===n?a.scrollViewX:a.scrollViewY,t.class].join(" ");e.state=m({},{pageSizes:{},sortedKeys:[],beforeSize:null,afterSize:null,scrollView:null,isScrolling:!1,scrollWatchScrollingStateId:null,scrollWatchUpdateStateId:null,preloadSlots:t.preloadPages||1,boundingClientRect:{},currentPageNum:0,scrollAmount:0,classList:c,axis:n,whichScroll:r,autoSize:i,pageSize:o,scrollThrottle:l,contentTag:s})},A=function(t){var n=t.state,r=t.attrs;n.scrollAmount=n.scrollView?n.scrollView[n.whichScroll]:0;var i=n.axis,o=void 0!==r.maxPages?r.maxPages:Number.MAX_VALUE,l=r.currentPage?parseInt(r.currentPage,10):P(n.scrollAmount,n);r.pageChange&&l!==n.currentPageNum&&r.pageChange(l),n.currentPageNum=l,n.scrollView&&r.getDimensions&&r.getDimensions({scrolled:n.scrollAmount,size:n.contentSize});var s=O(l,r.from,r.to,r.currentPage,n.preloadSlots,o),c=s.pages,u=s.prePages,d=s.maxPageNum;n.contentSize=N(1,d,n);var f=!d||T(d,i,n,n.scrollView);if(n.scrollView){var p=n.scrollView.getBoundingClientRect();n.boundingClientRect=n.boundingClientRect||p,p.width===n.boundingClientRect.width&&p.height===n.boundingClientRect.height||(n.preloadSlots=r.preloadPages||1),n.boundingClientRect=p;var g=r.maxPreloadPages||Number.MAX_VALUE;n.contentSize&&n.preloadSlots<c.length&&n.preloadSlots<=g&&n.contentSize<p.height&&(n.preloadSlots++,setTimeout(e.redraw,0))}return e("div",{oncreate:function(e){var t=e.dom;if(n.scrollView=r.scrollView?document.querySelector(r.scrollView):t,n.scrollView.className+=" "+n.classList,r.setDimensions){var a=r.setDimensions();if(a.size>0){var o="x"===i?"width":"height";t.style[o]=a.size+"px"}n.scrollView[n.whichScroll]=a.scrolled}C(n,n.scrollView,"add")},onremove:function(){return C(n,n.scrollView,"remove")}},e("div",{class:a.scrollContent,style:n.autoSize?m({},"x"===i?{width:n.contentSize+"px"}:{height:n.contentSize+"px"},r.contentSize?"x"===i?{"min-width":r.contentSize+"px"}:{"min-height":r.contentSize+"px"}:{}):null},[e(n.contentTag,{class:a.content},[r.before?e("div",{class:a.before,oncreate:function(e){var t=e.dom;return E(t,"before",n,i)},onupdate:function(e){var t=e.dom;return E(t,"before",n,i)}},r.before):null,e("div",{class:a.pages},[u.map(function(t){return e(S,m({},{axis:i,key:V(t),pageId:V(t),pageNum:t,pageSizes:n.pageSizes}))}),c.map(function(t){return e(h,m({},{autoSize:n.autoSize,axis:i,isScrolling:n.isScrolling,item:r.item,key:V(t),pageData:r.pageData,pageId:V(t),pageNum:t,pageSize:n.pageSize,pageSizes:n.pageSizes,pageTag:r.pageTag,pageUrl:r.pageUrl,updatePageSize:I(n)}))})]),r.after&&n.contentSize?e("div",{class:a.after,style:{visibility:f?"visible":"hidden"},oncreate:function(e){var t=e.dom;return E(t,"after",n,i)},onupdate:function(e){var t=e.dom;return E(t,"after",n,i)}},r.after):null])]))},D={oninit:j,view:A,isElementInViewport:s};return D});
//# sourceMappingURL=mithril-infinite.js.map
