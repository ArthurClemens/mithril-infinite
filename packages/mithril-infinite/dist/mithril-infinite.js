!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("mithril"),require("verge"),require("mithril/stream"),require("resize-observer-polyfill"),require("j2c")):"function"==typeof define&&define.amd?define(["mithril","verge","mithril/stream","resize-observer-polyfill","j2c"],t):(e=e||self).mithrilInfinite=t(e.m,e.verge,e.stream,e["resize-observer-polyfill"],e.j2c)}(this,(function(e,t,r,i,n){"use strict";function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i,n=n&&n.hasOwnProperty("default")?n.default:n;var l,s={scrollView:"mithril-infinite__scroll-view",scrollViewX:"mithril-infinite__scroll-view--x",scrollViewY:"mithril-infinite__scroll-view--y",scrollContent:"mithril-infinite__scroll-content",content:"mithril-infinite__content",pages:"mithril-infinite__pages",page:"mithril-infinite__page",pageEven:"mithril-infinite__page--even",pageOdd:"mithril-infinite__page--odd",placeholder:"mithril-infinite__page--placeholder",before:"mithril-infinite__before",after:"mithril-infinite__after"},c=function(e,t){return"x"===t?e.offsetWidth:e.offsetHeight},u=function(e){var r=e.el,i=e.axis,n=void 0===i?"y":i,o=e.leeway,a=void 0===o?300:o;return"y"===n?t.inY(r,a)||t.inY(r,-a):"x"===n?t.inX(r,a)||t.inX(r,-a):t.inViewport(r,a)||t.inViewport(r,-a)},g=function(e){return[s.page,e%2==0?s.pageEven:s.pageOdd].join(" ")},p={oninit:function(t){var i=t.state,n=t.attrs,o=n.pageNum,a=r([]);if(n.pageData){var l=n.pageData(o);Promise.resolve(l).then(a).then(e.redraw)}else if(n.pageUrl){(function(t){return e.request({method:"GET",url:t})})(n.pageUrl(o)).then(a)}var s=n.processPageData||function(e,t){return e&&e.length?e.map((function(e,r){return n.item(e,t,r)})):null};i.content=a,i.className=g(o),i.pageTag=n.pageTag||"div",i.processPageData=s},view:function(t){var r=t.state,n=t.attrs,o=n.pageId,a=n.pageSizes[o]||0,l=0;n.pageSize&&(l=n.pageSize(r.content()),n.updatePageSize(o,l));var s=l?l+"px":n.autoSize?"auto":a+"px",u=function(e){if(!l){var t=c(e,n.axis);t&&n.updatePageSize(o,t)}};return e(r.pageTag,{"data-page":o,class:r.className,style:a?"x"===n.axis?{width:s}:{height:s}:null,oncreate:function(e){var t=e.dom;new i((function(e){var r=!0,i=!1,o=void 0;try{for(var l,s=e[Symbol.iterator]();!(r=(l=s.next()).done);r=!0){var c=l.value.contentRect,g=c.width,p=c.height;("x"===n.axis&&g!==a||"y"===n.axis&&p!==a)&&u(t)}}catch(e){i=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}})).observe(t)},onupdate:function(e){var t=e.dom;return u(t)}},r.processPageData(r.content(),{pageId:n.pageId,pageNum:n.pageNum}))}},f={oninit:function(e){return e.state.className=g(e.attrs.pageNum)},view:function(t){var r=t.state,i=t.attrs,n=i.pageId,o=i.pageSizes[n]||0;return e("div",{"data-page":n,class:[s.placeholder,r.className].join(" "),style:a({},"x"===i.axis?{width:o+"px"}:{height:o+"px"})})}},d=new n,h=function(e){if(e){var t=document.getElementById(e);t&&t.parentNode.removeChild(t)}};!function(e){h(e);var t=document.createElement("style");e&&t.setAttribute("id",e);for(var r=arguments.length,i=new Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];i.forEach((function(e){Object.keys(e).length&&e.forEach((function(e){var r={"@global":e},i=d.sheet(r);t.appendChild(document.createTextNode(i))}))})),document.head.appendChild(t)}("mithril-infinite",[o({},"."+s.scrollView,(l={"-webkit-overflow-scrolling":"touch",height:"100%"},o(l," ."+s.scrollContent,{overflowAnchor:"none"}),o(l,"&."+s.scrollViewY,o({overflowX:"hidden",overflowY:"auto",height:"100%"}," ."+s.scrollContent,{height:"100%"})),o(l,"&."+s.scrollViewX,o({overflowX:"auto",overflowY:"hidden",width:"100%"}," ."+s.scrollContent,{width:"100%"})),l))]);var m=function(e){return"000000".substring(0,"000000".length-(""+e).length)+e},v=function(t){return function(r,i){var n=t.pageSizes[r],o=parseInt(i,10);n!==o&&(t.pageSizes[r]=o,t.sortedKeys=Object.keys(t.pageSizes).sort(),w(t),setTimeout(e.redraw))}},S=function(e,t,r,i){var n=c(e,i);n&&(r[t]=n)},w=function(t){if(t.scrollView){var r=t.scrollView.getBoundingClientRect();t.boundingClientRect=t.boundingClientRect||r,r.width===t.boundingClientRect.width&&r.height===t.boundingClientRect.height||(t.preloadSlots=void 0!==t.attrsPreloadSlots?t.attrsPreloadSlots:1),t.boundingClientRect=r,t.contentSize&&t.preloadSlots<t.pageCount&&t.preloadSlots<=t.attrsMaxPreloadSlots&&t.contentSize<r.height&&(t.preloadSlots++,setTimeout(e.redraw)),console.log("state.preloadSlots",t.preloadSlots)}};return{oninit:function(t){var r=t.attrs,i=r.axis||"y",n="x"===i?"scrollLeft":"scrollTop",o=void 0===r.autoSize||!1!==r.autoSize,l=r.pageSize,c=r.contentTag||"div",u=[s.scrollView,"x"===i?s.scrollViewX:s.scrollViewY,r.class].join(" "),g=e.redraw;a(t.state,{afterSize:0,beforeSize:0,boundingClientRect:{},currentPageNum:0,pageSizes:{},preloadSlots:void 0!==r.preloadPages?r.preloadPages:1,scrollView:null,sortedKeys:[],attrsMaxPreloadSlots:r.maxPreloadPages||Number.MAX_VALUE,attrsPreloadSlots:void 0!==r.preloadPages?r.preloadPages:1,autoSize:o,axis:i,classList:u,contentTag:c,pageSize:l,scroll:g,whichScroll:n})},view:function(t){var r=t.state,i=t.attrs,n=r.scrollView?r.scrollView[r.whichScroll]:0,o=r.axis,l=void 0!==i.maxPages?i.maxPages:Number.MAX_VALUE,c=i.currentPage?parseInt(i.currentPage,10):function(e,t){var r=t.sortedKeys;if(0===r.length)return 1;for(var i=t.before||0,n=1,o=0;o<r.length;o+=1){var a=r[o];e>i&&(n=parseInt(a,10)),i+=t.pageSizes[a]}return n}(n,r);i.pageChange&&c!==r.currentPageNum&&i.pageChange(c),r.currentPageNum=c,r.scrollView&&i.getDimensions&&i.getDimensions({scrolled:n,size:r.contentSize});var g=function(e,t,r,i,n,o){var a=t?parseInt(t,10):i||1,l=r?parseInt(r,10):i||o,s=[],c=[];console.log("fromPage",t,"toPage",r),console.log("minPageNum",a,"maxPageNum",l),console.log("preloadSlots",n),console.log("maxPages",o);for(var u=-n;u<=n;u+=1){var g=e+u;console.log("i",u,"pageNum",g),g>=a&&g<=l&&s.push(g)}for(var p=1;p<s[0];p+=1)c.push(p);return{pages:s,prePages:c,maxPageNum:l}}(c,i.from,i.to,i.currentPage,r.preloadSlots,l),d=g.pages,h=g.prePages,z=g.maxPageNum;r.contentSize=void 0!==i.contentSize?i.contentSize:function(e,t,r){var i=Math.max(0,e-1);if(t<i)return 0;var n=t,o=0;return o=r.sortedKeys.slice(i,n).reduce((function(e,t){return e+(r.pageSizes[t]||0)}),o)}(1,z,r),console.log("attrs.from",i.from),console.log("attrs.to",i.to),console.log("currentPageNum",c),console.log("pages",d),console.log("prePages",h),console.log("maxPageNum",z),w(r),r.pageCount=d.length,console.log("state.pageCount",r.pageCount);var x=!z||function(e,t,r){if(!r)return!1;var i=m(e),n=r.querySelector('[data-page="'.concat(i,'"]'));return u({el:n,axis:t})}(z,o,r.scrollView);return e("div",{oncreate:function(e){var t=e.dom;if(r.scrollView=i.scrollView?document.querySelector(i.scrollView):t,r.scrollView.className+=" "+r.classList,i.setDimensions){var n=i.setDimensions();if(n.size>0){var a="x"===o?"width":"height";t.style[a]=n.size+"px"}r.scrollView[r.whichScroll]=n.scrolled}r.scrollView.addEventListener("scroll",r.scroll)},onremove:function(){return r.scrollView.removeEventListener("scroll",r.scroll)}},e("div",{class:s.scrollContent,style:r.autoSize?a({},"x"===o?{width:r.contentSize+r.beforeSize+r.afterSize+"px"}:{height:r.contentSize+r.beforeSize+r.afterSize+"px"},i.contentSize?"x"===o?{"min-width":i.contentSize+r.beforeSize+r.afterSize+"px"}:{"min-height":i.contentSize+r.beforeSize+r.afterSize+"px"}:{}):null},[e(r.contentTag,{class:s.content},[i.before?e("div",{class:s.before,oncreate:function(e){var t=e.dom;return S(t,"beforeSize",r,o)},onupdate:function(e){var t=e.dom;return S(t,"beforeSize",r,o)}},i.before):null,e("div",{class:s.pages},[h.map((function(t){return e(f,{axis:o,key:(i.pageKey||m)(t),pageId:m(t),pageNum:t,pageSizes:r.pageSizes})})),d.map((function(t){return e(p,{autoSize:r.autoSize,axis:o,item:i.item,key:(i.pageKey||m)(t),pageData:i.pageData,pageId:m(t),pageNum:t,pageSize:r.pageSize,pageSizes:r.pageSizes,pageTag:i.pageTag,pageUrl:i.pageUrl,updatePageSize:v(r)})}))]),i.after&&r.contentSize?e("div",{class:s.after,style:{visibility:x?"visible":"hidden"},oncreate:function(e){var t=e.dom;return S(t,"afterSize",r,o)},onupdate:function(e){var t=e.dom;return S(t,"afterSize",r,o)}},i.after):null])]))},isElementInViewport:u}}));
//# sourceMappingURL=mithril-infinite.js.map
