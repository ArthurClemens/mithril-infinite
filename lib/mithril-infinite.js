"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(exports,"__esModule",{value:!0});var _ref3,_verge=require("verge"),_verge2=_interopRequireDefault(_verge),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril),_j2c=require("j2c"),_j2c2=_interopRequireDefault(_j2c),SEL_PADDING="000000",SCROLL_WATCH_TIMER=200,RESIZE_TIMER=500,LEEWAY=300,CSS_CLASSES={scrollView:"mithril-infinite__scroll-view",scrollViewX:"mithril-infinite__scroll-view--x",scrollViewY:"mithril-infinite__scroll-view--y",scrollContent:"mithril-infinite__scroll-content",content:"mithril-infinite__content",pages:"mithril-infinite__pages",page:"mithril-infinite__page",pageEven:"mithril-infinite__page--even",pageOdd:"mithril-infinite__page--odd",before:"mithril-infinite__before",after:"mithril-infinite__after"};Object.assign||(Object.assign=function(target,source){for(var key,index=1;index in arguments;++index){source=arguments[index];for(key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target});var numToId=function(pageNum){return SEL_PADDING.substring(0,SEL_PADDING.length-(""+pageNum).length)+pageNum},getElementSize=function(el,axis){var styles=window.getComputedStyle(el);if("x"===axis){var margin=parseFloat(styles.marginLeft)+parseFloat(styles.marginRight);return el.scrollWidth+margin}var _margin=parseFloat(styles.marginTop)+parseFloat(styles.marginBottom);return el.scrollHeight+_margin},getCurrentPage=function(scrollAmount,state){var pageNumKeys=Object.keys(state.dimensions).sort(),acc=state.before||0,currentPage=1;return pageNumKeys.forEach(function(pageKey){scrollAmount>acc&&(currentPage=parseInt(pageKey,10));var size=state.dimensions[pageKey];acc+=size}),currentPage},calculateSize=function(from,to,state){var fromIndex=Math.max(0,from-1);if(fromIndex>to)return 0;var toIndex=to,pageNumKeys=Object.keys(state.dimensions).sort().slice(fromIndex,toIndex),size=state.before||0;return pageNumKeys.forEach(function(pageKey){size+=state.dimensions[pageKey]||0}),size+=state.after||0},isPageInViewport=function(page,axis,state,scrollView){if(!scrollView)return!1;var id=numToId(page),el=scrollView.querySelector('[data-page="'+id+'"]');return infinite.isElementInViewport({el:el,axis:axis,leeway:LEEWAY})||infinite.isElementInViewport({el:el,axis:axis,leeway:-LEEWAY})},getPageData=function(url){return _mithril2["default"].request({method:"GET",url:url,initialValue:[],background:!0})},page={};page.controller=function(){var opts=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],content=_mithril2["default"].prop([]);if(opts.pageData){var result=opts.pageData(opts.page);result.then?result.then(function(r){content(r)}):content=result}else if(opts.pageUrl){var url=opts.pageUrl(opts.page);getPageData(url).then(function(data){content(data),_mithril2["default"].redraw()})}return{content:content}},page.view=function(ctrl){var opts=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],id=numToId(opts.page),pageTag=opts.pageTag||"div",className=[CSS_CLASSES.page,opts.page%2===0?CSS_CLASSES.pageEven:CSS_CLASSES.pageOdd].join(" "),dimensions=opts.state.dimensions,dimension=dimensions[id]||0;if(opts.placeholder)return(0,_mithril2["default"])("div",{"data-page":id,"class":className,style:dimension?Object.assign({},"x"===opts.axis?{width:dimension+"px"}:{height:dimension+"px"}):{}});var pageSize=0;opts.pageSize&&(pageSize=opts.pageSize(ctrl.content()),dimensions[id]=pageSize);var cssSize=pageSize?pageSize+"px":!opts.autoSize||opts.isScrolling&&dimension?dimension+"px":"auto",processPageData=opts.processPageData||function(content,opts1){return content?content.map(function(data,index){return opts.item(data,opts1,index)}):null};return(0,_mithril2["default"])(pageTag,{"data-page":id,"class":className,style:dimension?Object.assign({},"x"===opts.axis?{width:cssSize}:{height:cssSize}):{},config:pageSize?{}:function(el){var size=getElementSize(el,opts.axis),prevSize=dimensions[id];size&&(dimensions[id]=size),prevSize||setTimeout(_mithril2["default"].redraw,0)}},processPageData(ctrl.content(),opts))};var getDimensions=function(ctrl){return{scrolled:ctrl.scrollAmount,size:ctrl.contentSize}},infinite={};infinite.controller=function(opts){return{state:{dimensions:{}},scrollView:null,isScrolling:!1,scrollWatchScrollingStateId:null,scrollWatchUpdateStateId:null,preloadSlots:opts.preloadPages||1,boundingClientRect:{},currentPage:0,scrollAmount:0}},infinite.view=function(ctrl,opts){var maxPages=void 0!==opts.maxPages?opts.maxPages:Number.MAX_VALUE,state=ctrl.state,whichScroll="x"===opts.axis?"scrollLeft":"scrollTop";ctrl.scrollAmount=ctrl.scrollView?ctrl.scrollView[whichScroll]:0;var scrollThrottle=void 0!==opts.throttle?1e3*opts.throttle:SCROLL_WATCH_TIMER,autoSize=void 0===opts.autoSize||opts.autoSize!==!1,currentPage=opts.currentPage?parseInt(opts.currentPage,10):getCurrentPage(ctrl.scrollAmount,state);currentPage!==ctrl.currentPage&&opts.pageChange&&opts.pageChange(currentPage),ctrl.currentPage=currentPage,ctrl.scrollView&&opts.getDimensions&&opts.getDimensions(getDimensions(ctrl));for(var minPage=opts.from?parseInt(opts.from,10):opts.currentPage?opts.currentPage:1,maxPage=opts.to?parseInt(opts.to,10):opts.currentPage?opts.currentPage:maxPages,pages=[],prePages=[],i=-ctrl.preloadSlots;i<=ctrl.preloadSlots;i++){var pageNum=currentPage+i;pageNum>=minPage&&maxPage>=pageNum&&pages.push(pageNum)}for(var _pageNum=1;_pageNum<pages[0];_pageNum++)prePages.push(_pageNum);var contentTag=opts.contentTag||"div",classList=[CSS_CLASSES.scrollView,"x"===opts.axis?CSS_CLASSES.scrollViewX:CSS_CLASSES.scrollViewY,opts["class"]].join(" ");ctrl.contentSize=calculateSize(1,maxPage,state);var isLastPageVisible=maxPage?isPageInViewport(maxPage,opts.axis,state,ctrl.scrollView):!0;if(ctrl.scrollView){var boundingClientRect=ctrl.scrollView.getBoundingClientRect();ctrl.boundingClientRect=ctrl.boundingClientRect||boundingClientRect,boundingClientRect.width===ctrl.boundingClientRect.width&&boundingClientRect.height===ctrl.boundingClientRect.height||(ctrl.preloadSlots=opts.preloadPages||1),ctrl.boundingClientRect=boundingClientRect;var maxSlots=opts.maxPreloadPages||Number.MAX_VALUE;ctrl.contentSize&&ctrl.preloadSlots<pages.length&&ctrl.preloadSlots<=maxSlots&&ctrl.contentSize<boundingClientRect.height&&(ctrl.preloadSlots++,setTimeout(_mithril2["default"].redraw,0))}var content=(0,_mithril2["default"])("div",{config:function(el,inited,context){if(!inited){if(opts.scrollView?ctrl.scrollView=document.querySelector(opts.scrollView):ctrl.scrollView=el,ctrl.scrollView.className+=" "+classList,opts.setDimensions){var dimensions=opts.setDimensions(),whichSize="x"===opts.axis?"width":"height";dimensions.size>0&&(el.style[whichSize]=dimensions.size+"px"),ctrl.scrollView[whichScroll]=dimensions.scrolled}var handleScroll=function(){ctrl.isScrolling=!0,clearTimeout(ctrl.scrollWatchScrollingStateId),ctrl.scrollWatchScrollingStateId=setTimeout(function(){ctrl.isScrolling=!1,_mithril2["default"].redraw()},scrollThrottle),ctrl.scrollWatchUpdateStateId||(ctrl.scrollWatchUpdateStateId=setTimeout(function(){_mithril2["default"].redraw(),ctrl.scrollWatchUpdateStateId=null},scrollThrottle))};ctrl.scrollView.addEventListener("scroll",handleScroll),context.onunload=function(){ctrl.scrollView.removeEventListener("scroll",handleScroll)}}}},(0,_mithril2["default"])("div",{"class":CSS_CLASSES.scrollContent,style:autoSize?Object.assign({},"x"===opts.axis?{width:ctrl.contentSize+"px"}:{height:ctrl.contentSize+"px"},opts.contentSize?"x"===opts.axis?{"min-width":opts.contentSize+"px"}:{"min-height":opts.contentSize+"px"}:{}):{}},[(0,_mithril2["default"])(contentTag,{"class":CSS_CLASSES.content},[opts.before?(0,_mithril2["default"])("div",{"class":CSS_CLASSES.before,config:function(el){var size=getElementSize(el,opts.axis);size&&(ctrl.state.before=size)}},opts.before):null,(0,_mithril2["default"])("div",{"class":CSS_CLASSES.pages},[prePages.map(function(p){return _mithril2["default"].component(page,Object.assign({},opts,{page:p,placeholder:!0,isScrolling:ctrl.isScrolling,state:state,autoSize:autoSize}))}),pages.map(function(p){return _mithril2["default"].component(page,Object.assign({},opts,{page:p,isScrolling:ctrl.isScrolling,state:state,autoSize:autoSize}))})]),opts.after&&ctrl.contentSize?(0,_mithril2["default"])("div",{"class":CSS_CLASSES.after,style:{visibility:isLastPageVisible?"visible":"hidden"},config:function(el){var size=getElementSize(el,opts.axis);size&&(ctrl.state.after=size)}},opts.after):null])]));return content},infinite.isElementInViewport=function(opts){var el=opts.el,leeway=void 0!==opts.leeway?opts.leeway:LEEWAY,axis=opts.axis||"y";return{x:_verge2["default"].inX(el,leeway),y:_verge2["default"].inY(el,leeway),both:_verge2["default"].inViewport(el,leeway)}[axis]};var resizeTimer=0;window.onresize=function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(_mithril2["default"].redraw,RESIZE_TIMER)};var styler={add:function(id){for(var _len=arguments.length,styles=Array(_len>1?_len-1:0),_key=1;_len>_key;_key++)styles[_key-1]=arguments[_key];styler.remove(id);var styleEl=document.createElement("style");id&&styleEl.setAttribute("id",id),styles.forEach(function(styleList){Object.keys(styleList).length&&styleList.forEach(function(style){var scoped={"@global":style},sheet=_j2c2["default"].sheet(scoped);styleEl.appendChild(document.createTextNode(sheet))})}),document.head.appendChild(styleEl)},remove:function(id){if(id){var old=document.getElementById(id);old&&old.parentNode.removeChild(old)}}},styles=[_defineProperty({},"."+CSS_CLASSES.scrollView,(_ref3={"-webkit-overflow-scrolling":"touch",height:"100%"},_defineProperty(_ref3,"&."+CSS_CLASSES.scrollViewY,_defineProperty({"overflow-x":"hidden","overflow-y":"auto",height:"100%"}," ."+CSS_CLASSES.scrollContent,{height:"100%"})),_defineProperty(_ref3,"&."+CSS_CLASSES.scrollViewX,_defineProperty({"overflow-x":"auto","overflow-y":"hidden",width:"100%"}," ."+CSS_CLASSES.scrollContent,{width:"100%"})),_ref3))];styler.add("mithril-infinite",styles),exports["default"]=infinite,module.exports=exports["default"];
//# sourceMappingURL=mithril-infinite.js.map