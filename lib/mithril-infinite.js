"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}Object.defineProperty(exports,"__esModule",{value:!0});var _ref3,_verge=require("verge"),_verge2=_interopRequireDefault(_verge),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril),_j2c=require("j2c"),_j2c2=_interopRequireDefault(_j2c),SEL_PADDING="000000",SCROLL_WATCH_TIMER=200,RESIZE_TIMER=500,LEEWAY=300,CSS_CLASSES={scrollView:"mithril-infinite__scroll-view",scrollViewX:"mithril-infinite__scroll-view--x",scrollViewY:"mithril-infinite__scroll-view--y",scrollContent:"mithril-infinite__scroll-content",content:"mithril-infinite__content",pages:"mithril-infinite__pages",page:"mithril-infinite__page",pageEven:"mithril-infinite__page--even",pageOdd:"mithril-infinite__page--odd",before:"mithril-infinite__before",after:"mithril-infinite__after"};Object.assign||(Object.assign=function(r,e){for(var t,i=1;i in arguments;++i){e=arguments[i];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t])}return r});var numToId=function(e){return SEL_PADDING.substring(0,SEL_PADDING.length-(""+e).length)+e},getElementSize=function(t,r){var e=window.getComputedStyle(t);if("x"===r){var i=parseFloat(e.marginLeft)+parseFloat(e.marginRight);return Math.round(t.scrollWidth+i)}var i=parseFloat(e.marginTop)+parseFloat(e.marginBottom);return Math.round(t.scrollHeight+i)},getCurrentPage=function(r,e){var n=Object.keys(e.dimensions).sort(),t=e.before||0,i=1;return n.forEach(function(n){r>t&&(i=parseInt(n,10));var l=e.dimensions[n];t+=l}),i},calculateSize=function(n,t,e){var i=Math.max(0,n-1);if(i>t)return 0;var l=t,a=Object.keys(e.dimensions).sort().slice(i,l),r=e.before||0;return a.forEach(function(t){r+=e.dimensions[t]||0}),r+=e.after||0},isPageInViewport=function(r,e,l,t){if(!t)return!1;var n=numToId(r),i=t.querySelector('[data-page="'+n+'"]');return infinite.isElementInViewport({el:i,axis:e,leeway:LEEWAY})||infinite.isElementInViewport({el:i,axis:e,leeway:-LEEWAY})},getPageData=function(e){return _mithril2.default.request({method:"GET",url:e,initialValue:[],background:!0})},page={};page.controller=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=_mithril2.default.prop([]);if(e.pageData)t=e.pageData(e.page);else if(e.pageUrl){var i=e.pageUrl(e.page);getPageData(i).then(function(e){t(e),_mithril2.default.redraw()})}return{content:t}},page.view=function(l){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],t=numToId(e.page),s=e.pageTag||"div",a=[CSS_CLASSES.page,e.page%2===0?CSS_CLASSES.pageEven:CSS_CLASSES.pageOdd].join(" "),n=e.state.dimensions,i=n[t]||0;if(e.placeholder)return _mithril2.default("div",{"data-page":t,class:a,style:i?Object.assign({},"x"===e.axis?{width:i+"px"}:{height:i+"px"}):{}});var r=0;e.pageSize&&(r=e.pageSize(l.content()),n[t]=r);var o=r?r+"px":!e.autoSize||e.isScrolling&&i?i+"px":"auto",c=e.processPageData||function(t,i){return t?t.map(function(t,r){return e.item(t,i,r)}):null};return _mithril2.default(s,{"data-page":t,class:a,style:i?Object.assign({},"x"===e.axis?{width:o}:{height:o}):{},config:r?{}:function(r){var i=getElementSize(r,e.axis),l=n[t];i&&(n[t]=i),l||setTimeout(_mithril2.default.redraw,0)}},c(l.content(),e))};var infinite={};infinite.controller=function(e){return{state:{dimensions:{}},scrollView:null,isScrolling:!1,scrollWatchScrollingStateId:null,scrollWatchUpdateStateId:null,preloadSlots:e.preloadPages||1,boundingClientRect:{},currentPage:0}},infinite.view=function(t,e){var v=e.maxPages||Number.MAX_VALUE,i=t.state,h=t.scrollView?"x"===e.axis?t.scrollView.scrollLeft:t.scrollView.scrollTop:0,f=void 0!==e.throttle?1e3*e.throttle:SCROLL_WATCH_TIMER,c=void 0!==e.autoSize&&e.autoSize===!1?!1:!0,s=e.currentPage?parseInt(e.currentPage,10):getCurrentPage(h,i);s!==t.currentPage&&e.pageChange&&e.pageChange(s),t.currentPage=s;for(var d=e.from?parseInt(e.from,10):e.currentPage?e.currentPage:1,a=e.to?parseInt(e.to,10):e.currentPage?e.currentPage:v,o=[],g=[],u=-t.preloadSlots;u<=t.preloadSlots;u++){var n=s+u;n>=d&&a>=n&&o.push(n)}for(var n=1;n<o[0];n++)g.push(n);var S=e.contentTag||"div",p=[CSS_CLASSES.scrollView,"x"===e.axis?CSS_CLASSES.scrollViewX:CSS_CLASSES.scrollViewY,e.class].join(" "),r=calculateSize(1,a,i),m=isPageInViewport(d,e.axis,i,t.scrollView),_=a?isPageInViewport(a,e.axis,i,t.scrollView):!0;if(t.scrollView){var l=t.scrollView.getBoundingClientRect();t.boundingClientRect=t.boundingClientRect||l,(l.width!==t.boundingClientRect.width||l.height!==t.boundingClientRect.height)&&(t.preloadSlots=e.preloadPages||1),t.boundingClientRect=l;var w=e.maxPreloadPages||Number.MAX_VALUE;r&&t.preloadSlots<o.length&&t.preloadSlots<=w&&r<l.height&&(t.preloadSlots++,setTimeout(_mithril2.default.redraw,0))}var C=_mithril2.default("div",{config:function(r,n,l){if(!n){t.scrollView=e.scrollView?document.querySelector(e.scrollView):r,t.scrollView.className+=" "+p;var i=function(){t.isScrolling=!0,clearTimeout(t.scrollWatchScrollingStateId),t.scrollWatchScrollingStateId=setTimeout(function(){t.isScrolling=!1,_mithril2.default.redraw()},f),t.scrollWatchUpdateStateId||(t.scrollWatchUpdateStateId=setTimeout(function(){_mithril2.default.redraw(),t.scrollWatchUpdateStateId=null},f))};t.scrollView.addEventListener("scroll",i),l.onunload=function(){t.scrollView.removeEventListener("scroll",i)}}}},_mithril2.default("div",{class:CSS_CLASSES.scrollContent,style:c?Object.assign({},"x"===e.axis?{width:r+"px"}:{height:r+"px"},e.contentSize?"x"===e.axis?{"min-width":e.contentSize+"px"}:{"min-height":e.contentSize+"px"}:{}):{}},[_mithril2.default(S,{class:CSS_CLASSES.content},[e.before&&r?_mithril2.default("div",{class:CSS_CLASSES.before,style:{visibility:m?"visible":"hidden"},config:function(r){var i=getElementSize(r,e.axis);i&&(t.state.before=i)}},e.before):null,_mithril2.default("div",{class:CSS_CLASSES.pages},[g.map(function(r){return _mithril2.default.component(page,Object.assign({},e,{page:r,placeholder:!0,isScrolling:t.isScrolling,state:i,autoSize:c}))}),o.map(function(r){return _mithril2.default.component(page,Object.assign({},e,{page:r,isScrolling:t.isScrolling,state:i,autoSize:c}))})]),e.after&&r?_mithril2.default("div",{class:CSS_CLASSES.after,style:{visibility:_?"visible":"hidden"},config:function(r){var i=getElementSize(r,e.axis);i&&(t.state.after=i)}},e.after):null])]));return C},infinite.isElementInViewport=function(e){var t=e.el,i=void 0!==e.leeway?e.leeway:LEEWAY,r=e.axis||"y";return{x:_verge2.default.inX(t,i),y:_verge2.default.inY(t,i),both:_verge2.default.inViewport(t,i)}[r]};var resizeTimer=0;window.onresize=function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(_mithril2.default.redraw,RESIZE_TIMER)};var styler={add:function(t){for(var i=arguments.length,n=Array(i>1?i-1:0),e=1;i>e;e++)n[e-1]=arguments[e];styler.remove(t);var r=document.createElement("style");t&&r.setAttribute("id",t),n.forEach(function(e){Object.keys(e).length&&e.forEach(function(e){var t={"@global":e},i=_j2c2.default.sheet(t);r.appendChild(document.createTextNode(i))})}),document.head.appendChild(r)},remove:function(t){if(t){var e=document.getElementById(t);e&&e.parentNode.removeChild(e)}}},styles=[_defineProperty({},"."+CSS_CLASSES.scrollView,(_ref3={"-webkit-overflow-scrolling":"touch",height:"100%"},_defineProperty(_ref3,"&."+CSS_CLASSES.scrollViewY,_defineProperty({"overflow-x":"hidden","overflow-y":"auto",height:"100%"}," ."+CSS_CLASSES.scrollContent,{height:"100%"})),_defineProperty(_ref3,"&."+CSS_CLASSES.scrollViewX,_defineProperty({"overflow-x":"auto","overflow-y":"hidden",width:"100%"}," ."+CSS_CLASSES.scrollContent,{width:"100%"})),_ref3))];styler.add("mithril-infinite",styles),exports.default=infinite,module.exports=exports.default;