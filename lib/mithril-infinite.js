"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _verge=require("verge"),_verge2=_interopRequireDefault(_verge),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril),SEL_PADDING="000000",SCROLL_WATCH_TIMER=200,RESIZE_TIMER=500,LEEWAY=100;Object.assign||(Object.assign=function(r,e){for(var t,i=1;i in arguments;++i){e=arguments[i];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t])}return r});var numToId=function(e){return SEL_PADDING.substring(0,SEL_PADDING.length-(""+e).length)+e},getElementSize=function(t,r){var e=window.getComputedStyle(t);if("x"===r){var i=parseFloat(e.marginLeft)+parseFloat(e.marginRight);return Math.ceil(t.scrollWidth+i)}var i=parseFloat(e.marginTop)+parseFloat(e.marginBottom);return Math.ceil(t.scrollHeight+i)},getCurrentPage=function(r,e){var n=Object.keys(e.dimensions).sort(),t=e.before||0,i=1;return n.forEach(function(n){r>t&&(i=parseInt(n,10));var a=e.dimensions[n];t+=a}),i},calculateSize=function(n,t,e){var i=Math.max(0,n-1);if(i>t)return 0;var a=t,l=Object.keys(e.dimensions).sort().slice(i,a),r=e.before||0;return l.forEach(function(t){r+=e.dimensions[t]||0}),r+=e.after||0},calculateStartToContent=function(e,t,i){var r=1,n=e+t;return calculateSize(r,n,i)},calculateContentSize=function(e,t,i){var r=e-t,n=e+t;return calculateSize(r,n,i)},calculatePaddingAfter=function(t,i,e){var r=t+i,n=Object.keys(e.dimensions).length;return calculateSize(r,n,e)},isPageInViewport=function(t,i,a,e){if(!e)return!1;var r=numToId(t),n=e.querySelector('[data-page="'+r+'"]');return infinite.isElementInViewport({el:n,axis:i})},getPageData=function(e){return _mithril2.default.request({method:"GET",url:e,initialValue:[],background:!0})},page={};page.controller=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=_mithril2.default.prop([]);if(e.pageData)t=e.pageData(e.page);else{var i=e.pageUrl(e.page);getPageData(i).then(function(e){t(e),_mithril2.default.redraw()})}return{content:t}},page.view=function(a){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],t=numToId(e.page),o=e.pageTag||"div",s=["page",e.page%2===0?"even":"odd"].join(" "),c=e.processPageData||function(t,i){return t?t.map(function(t,r){return e.item(t,i,r)}):null},r=e.state.dimensions,n=r[t]||0,i=0;e.pageSize&&(i=e.pageSize(a.content()),r[t]=i);var l=i?i+"px":e.isScrolling&&n?n+"px":"auto";return _mithril2.default(o,{"data-page":t,class:s,style:n?Object.assign({},"x"===e.axis?{width:l}:{height:l}):{},config:i?{}:function(n){var i=getElementSize(n,e.axis),a=r[t];i&&(r[t]=i),a||setTimeout(_mithril2.default.redraw,0)}},c(a.content(),e))};var infinite={};infinite.controller=function(e){return{state:{dimensions:{}},scrollView:null,isScrolling:!1,scrollWatchScrollingStateId:null,scrollWatchUpdateStateId:null,paddingAfter:null,preloadSlots:e.preloadPages||1,boundingClientRect:{},currentPage:0}},infinite.view=function(t,e){var w=e.maxPages||Number.MAX_VALUE,i=t.state,v=t.scrollView?"x"===e.axis?t.scrollView.scrollLeft:t.scrollView.scrollTop:0,r=e.currentPage?parseInt(e.currentPage,10):getCurrentPage(v,i);r!==t.currentPage&&e.pageChange&&e.pageChange(r),t.currentPage=r;for(var f=e.from?parseInt(e.from,10):e.currentPage?e.currentPage:1,d=e.to?parseInt(e.to,10):e.currentPage?e.currentPage:w,s=[],c=-t.preloadSlots;c<=t.preloadSlots;c++){var u=r+c;u>=f&&d>=u&&s.push(u)}var g=e.from?e.to-e.from:e.currentPage?1:t.preloadSlots,h=e.contentTag||"div",m=["scroll-view","scroll-view-"+(e.axis||"y"),e.class||""],p=e.from||e.currentPage?0:calculateStartToContent(r,g,i),n=calculateContentSize(r,g,i),o=e.from||e.currentPage?0:p-n,l=e.from||e.currentPage?0:e.contentSize?0:calculatePaddingAfter(r,g,i),S=isPageInViewport(f,e.axis,i,t.scrollView),_=d?isPageInViewport(d,e.axis,i,t.scrollView):!0;if(t.scrollView){var a=t.scrollView.getBoundingClientRect();t.boundingClientRect=t.boundingClientRect||a,(a.width!==t.boundingClientRect.width||a.height!==t.boundingClientRect.height)&&(t.preloadSlots=e.preloadPages||1),t.boundingClientRect=a,t.preloadSlots<s.length&&n<a.height&&(t.preloadSlots++,setTimeout(_mithril2.default.redraw,0))}var x=_mithril2.default("div",{config:function(r,n,a){if(!n){t.scrollView=e.scrollView?document.querySelector(e.scrollView):r,t.scrollView.className+=" "+m.join(" ");var i=function(){t.isScrolling=!0,clearTimeout(t.scrollWatchScrollingStateId),t.scrollWatchScrollingStateId=setTimeout(function(){t.isScrolling=!1,_mithril2.default.redraw()},SCROLL_WATCH_TIMER),t.scrollWatchUpdateStateId||(t.scrollWatchUpdateStateId=setTimeout(function(){_mithril2.default.redraw(),t.scrollWatchUpdateStateId=null},SCROLL_WATCH_TIMER))};t.scrollView.addEventListener("scroll",i),a.onunload=function(){t.scrollView.removeEventListener("scroll",i)}}}},_mithril2.default(".scroll-content",{style:e.autoSize?{}:Object.assign({},"x"===e.axis?{width:o+n+l+"px"}:{height:o+n+l+"px"},e.contentSize?"x"===e.axis?{"min-width":e.contentSize+"px"}:{"min-height":e.contentSize+"px"}:{})},[_mithril2.default(".padding-before",{style:Object.assign({},"x"===e.axis?{width:o+"px"}:{height:o+"px"})}),_mithril2.default(h,{class:"content"},[e.before&&n?_mithril2.default(".before",{style:{visibility:S?"visible":"hidden"},config:function(r){var i=getElementSize(r,e.axis);i&&(t.state.before=i)}},e.before):null,_mithril2.default(".pages",s.map(function(r){return _mithril2.default.component(page,Object.assign({},e,{page:r,key:r,isScrolling:t.isScrolling,scrollView:t.scrollView,state:i}))})),e.after&&n?_mithril2.default(".after",{style:{visibility:_?"visible":"hidden"},config:function(r){var i=getElementSize(r,e.axis);i&&(t.state.after=i)}},e.after):null]),_mithril2.default(".padding-after",{style:Object.assign({},"x"===e.axis?{width:l+"px"}:{height:l+"px"})})]));return x},infinite.isElementInViewport=function(e){var t=e.el,i=e.leeway||LEEWAY,r=e.axis||"y";return{x:_verge2.default.inX(t,i),y:_verge2.default.inY(t,i),both:_verge2.default.inViewport(t,i)}[r]};var resizeTimer=0;window.onresize=function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(_mithril2.default.redraw,RESIZE_TIMER)},exports.default=infinite;