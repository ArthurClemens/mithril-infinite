"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}Object.defineProperty(exports,"__esModule",{value:!0});var _verge=require("verge"),_verge2=_interopRequireDefault(_verge),_mithril=require("mithril"),_mithril2=_interopRequireDefault(_mithril),SEL_PADDING="000000",SCROLL_WATCH_TIMER=200,RESIZE_TIMER=500,LEEWAY=100;Object.assign||(Object.assign=function(n,e){for(var i=1,t=void 0;i in arguments;++i){e=arguments[i];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])}return n});var infinite={};infinite.numToId=function(e){return SEL_PADDING.substring(0,SEL_PADDING.length-(""+e).length)+e},infinite.getElementSize=function(t,n){var e=window.getComputedStyle(t);if("x"===n){var i=parseFloat(e.marginLeft)+parseFloat(e.marginRight);return Math.ceil(t.scrollWidth+i)}var i=parseFloat(e.marginTop)+parseFloat(e.marginBottom);return Math.ceil(t.scrollHeight+i)},infinite.getCurrentPage=function(n,e){var r=Object.keys(e.dimensions).sort(),t=e.before||0,i=1;return r.forEach(function(r){n>t&&(i=parseInt(r,10));var a=e.dimensions[r];t+=a}),i},infinite.calculateSize=function(r,t,e){var i=Math.max(0,r-1);if(i>t)return 0;var a=t,l=Object.keys(e.dimensions).sort().slice(i,a),n=e.before||0;return l.forEach(function(t){n+=e.dimensions[t]||0}),n+=e.after||0},infinite.calculateStartToContent=function(e,t,i){var n=1,r=e+t;return infinite.calculateSize(n,r,i)},infinite.calculateContentSize=function(e,t,i){var n=e-t,r=e+t;return infinite.calculateSize(n,r,i)},infinite.calculatePaddingAfter=function(t,i,e){var n=t+i,r=Object.keys(e.dimensions).length;return infinite.calculateSize(n,r,e)},infinite.isElementInViewport=function(e){var t=e.el,i=e.leeway||LEEWAY,n=e.axis||"y";return{x:_verge2.default.inX(t,i),y:_verge2.default.inY(t,i),both:_verge2.default.inViewport(t,i)}[n]};var getPageData=function(e){return _mithril2.default.request({method:"GET",url:e,initialValue:[],background:!0})},page={};page.controller=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=_mithril2.default.prop([]);if(e.pageData)t=e.pageData(e.page);else{var i=e.pageUrl(e.page);getPageData(i).then(function(e){t(e),_mithril2.default.redraw()})}return{content:t}},page.view=function(r){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=infinite.numToId(e.page),l=e.pageTag||"div",o=["page",e.page%2===0?"even":"odd"].join(" "),s=e.processPageData||function(t,i){return t?t.map(function(t,n){return e.item(t,i,n)}):null},n=e.state.dimensions[i]||0,t=0;e.pageSize&&(t=e.pageSize(r.content()),e.state.dimensions[i]=t);var a=t?t+"px":e.isScrolling&&n?n+"px":"auto";return(0,_mithril2.default)(l,{"data-page":i,class:o,style:n?Object.assign({},"x"===e.axis?{width:a}:{height:a}):{},config:t?{}:function(n){var t=infinite.getElementSize(n,e.axis);t&&(e.state.dimensions[i]=t)}},s(r.content(),e))},infinite.controller=function(e){return{state:{dimensions:{}},maxPages:e.maxPages||Number.MAX_VALUE,scrollView:null,isScrolling:!1,scrollWatchScrollingStateId:null,scrollWatchUpdateStateId:null,paddingAfter:null,preloadSlots:e.preloadPages||1,boundingClientRect:{},currentPage:0}},infinite.view=function(e,t){var r=e.state,g=e.scrollView?"x"===t.axis?e.scrollView.scrollLeft:e.scrollView.scrollTop:0,i=infinite.getCurrentPage(g,r);i!==e.currentPage&&t.pageChange&&t.pageChange(i),e.currentPage=i;for(var u=[],s=-e.preloadSlots;s<=e.preloadSlots;s++){var c=i+s;c>0&&c<=e.maxPages&&u.push(c)}var m=t.contentTag||"div",f=["scroll-view","scroll-view-"+(t.axis||"y")];t.class&&f.push(t.class);var d=infinite.calculateStartToContent(i,e.preloadSlots,r),n=infinite.calculateContentSize(i,e.preloadSlots,r),l=d-n,o=t.contentSize?0:infinite.calculatePaddingAfter(i,e.preloadSlots,r);if(e.scrollView){var a=e.scrollView.getBoundingClientRect();e.boundingClientRect=e.boundingClientRect||a,(a.width!==e.boundingClientRect.width||a.height!==e.boundingClientRect.height)&&(e.preloadSlots=t.preloadPages||1),e.boundingClientRect=a,0===n?_mithril2.default.redraw():n>0&&n<a.height&&(e.preloadSlots++,_mithril2.default.redraw())}var p=(0,_mithril2.default)("div",{config:function(r,a,l){var i;if(!a){t.scrollView?e.scrollView=document.querySelector(t.scrollView):e.scrollView=r;var o=f.join(" ").split(" ");(i=e.scrollView.classList).add.apply(i,_toConsumableArray(o));var n=function(){e.isScrolling=!0,clearTimeout(e.scrollWatchScrollingStateId),e.scrollWatchScrollingStateId=setTimeout(function(){e.isScrolling=!1,_mithril2.default.redraw()},SCROLL_WATCH_TIMER),e.scrollWatchUpdateStateId||(e.scrollWatchUpdateStateId=setTimeout(function(){_mithril2.default.redraw(),e.scrollWatchUpdateStateId=null},SCROLL_WATCH_TIMER))};e.scrollView.addEventListener("scroll",n),l.onunload=function(){e.scrollView.removeEventListener("scroll",n)}}}},(0,_mithril2.default)(".scroll-content",{style:Object.assign({},"x"===t.axis?{width:l+n+o+"px"}:{height:l+n+o+"px"},t.contentSize?"x"===t.axis?{"min-width":t.contentSize+"px"}:{"min-height":t.contentSize+"px"}:{})},[(0,_mithril2.default)(".padding-before",{style:Object.assign({},"x"===t.axis?{width:l+"px"}:{height:l+"px"})}),(0,_mithril2.default)(m,{class:"content"},[t.before?(0,_mithril2.default)(".before",{config:function(n){var i=infinite.getElementSize(n,t.axis);i&&(e.state.before=i)}},t.before):null,(0,_mithril2.default)(".pages",u.map(function(i){return _mithril2.default.component(page,Object.assign({},t,{page:i,key:i,isScrolling:e.isScrolling,scrollView:e.scrollView,state:r}))})),t.after&&n?(0,_mithril2.default)(".after",{config:function(n){var i=infinite.getElementSize(n,t.axis);i&&(e.state.after=i)}},t.after):null]),(0,_mithril2.default)(".padding-after",{style:Object.assign({},"x"===t.axis?{width:o+"px"}:{height:o+"px"})})]));return p};var resizeTimer=0;window.onresize=function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){_mithril2.default.redraw()},RESIZE_TIMER)},exports.default=infinite,module.exports=exports.default;